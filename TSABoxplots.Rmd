---
title: "TSA Claims Insights"
author: "Derek Orji, Brandon Kerbow"
resource_files:
- .Renviron
output:
  html_notebook:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
runtime: shiny
---

```{r setup, include=FALSE}

#RELATIONSHIP BETWEEN CANATTAS VARIABLES AND OURS, respectively
#regions : Airlines
#selectRegion_1: selectAirline
#Select Region: Select Airline
#salesFilter_1: closeAmountFilter
#Regions: airlines
#sales: close_amount
#region: airline_name


library(tidyverse)
library(data.world)
library(DT)
library(plotly)
library(lubridate)
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
sessionInfo()
```

```{r}
project <- "https://data.world/derek-orji/s-18-edv-project-1" 
data.world::set_config(cfg_env("DW_API")) 
Airlines <- data.world::query(data.world::qry_sql(
 "   
	select distinct claimsnew.airline_name 
	from claimsnew 
 "), 
dataset = project)
```

```{r}
inputPanel(
  selectInput("selectAirline", label = "Select Airline",
              choices = Airlines, multiple=TRUE, selected=c("Allegiant Air","Unknown","Southwest Airlines","USAir","American Airlines","Etihad Airways","Delta Air Lines","Spirit Airlines","UAL","Frontier Airlines","Emirates","British Airways","Southeast Airlines","KLM Royal Dutch Airlines","Alaska Airlines","Direct Air","Jet Blue","TAP Portugal","Virgin America","Air New Zealand","Swiss Air","Lufthansa","Copa Airlines","Scandinavian Airlines Systems","Air Canada","Turkish Airlines","Austrian Airlines","Jet Airways","Czechoslavak Airlines","EL AL Israeli Airlines","Virgin Atlantic","American Eagle","Silverjet","Cathay Pacific Unknown CX","Air Tahiti Nui","Hawaiian Airlines","Sata","Iberia Airlines","Air France","Pakistan International Airlines Cor","Aires Airline","Norwegian Airlines","Westjet Airlines Ltd","Bahama Airlines","Avianca","CanJet","SunWing Airlines","Carribean Airlines","Sun Country Airlines Inc","Philippine Airlines","Korean Airlines","Qantas Airlines","Island Air","Japan Airlines","Cape Air","Qatar airlines","Iceland Air","South African Airways","Middle East Airlines","Ethopian Airlines","Aero Mexico","Aero Flot","Aer Lingus","North American Airlines","Singapore Airlines","LOT Polish Airlines","Asiana Airlines","China Eastern Airlines","Transaero Airlines","EVA airlines","Finnair","Royal Dutch Airlines","Air India","Lan Airlines","Republic Airways","Air Berlin","Brit Air","Aerolineas Argentinas","Alitalia","Arik Airlines","Polish Airlines","Brussels Airlines","Air China","Royal Jordanian Airline","Air Europa","TAM airlines","China Southern Airlines","Egypt Air","Delta (Song)","OMNI Air ExpressUnknown (OY)","V Australia","China Airlines","All Nippon Airways","Volaris Airlines","Virgin Express","Czech Airlines","Thai Airways","Canadian Airlines","Western Pacific Airlines Inc Westpac","Kuwait Airways","Santa Barbara Airlines","Carnival Airlines","Air Aruba","Webjet","Xtra Airways","Cayman Airlines","Aloha Airlines","Aero Lineas Mexicanas J S S A De C V","Great Lakes Airline","America Trans Air","Condor Air","Skywest Airlines Inc USA","Horizon Air","Hainan Airlines","Seaborne Airlines","Allegheny Airlines Inc","US Express")),
  sliderInput("CloseAmountFilter", label = "Close Amount:",
              min = 0, max = 5403, value = c(0, 100200), step = 10)
)
```





#eventReactive is a function that tells it "if any of those things on the panel change"
#then re-run the code below. so everything you change something on the panel, this code
#will change. which makes sense because if we change the slider we want to re-run the query


#then the SQL says we want four columns from the superstore data....
#what do the ? come from? they com from the panel (the UI),
#and as you see below they are called inputSalesFiler1 and inputSalesFilter2
#and we want regeion to be whatever we selected above i.e. what we selected in the UI
#so the question marks get filled in the panel, and the functon paramQueryparams
#fills those ? in based on the panel. This is called a parmeratized (has ? marks)
#SQL query. then the question marks 

#and the results of this query went into df....what went info df is the output
#of an event reative....which is not a dataframe. what eventReactive returns
#is a functon. this function must be called to return the dataframes.

```{r}

df <- eventReactive(c(input$selectAirline, input$closeAmountFilter), { 
  project <- "https://data.world/derek-orji/s-18-edv-project-1" 
  data.world::set_config(cfg_env("DW_API")) 
  paramQuery <- data.world::qry_sql(
   "   
  	select c.claim_number, c.airline_name, c.close_amount, c.incident_d, c.item_category
  	from claimsnew c
    where c.close_amount between ? and ? and c.airline_name in

(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)

order by c.airline_name
   ")
  paramQuery$params <- c(input$closeAmountFilter[1], input$closeAmountFilter[2], input$selectAirline[1], input$selectAirline[2], input$selectAirline[3], input$selectAirline[4], input$selectAirline[5], input$selectAirline[6], input$selectAirline[7], input$selectAirline[8], input$selectAirline[9], input$selectAirline[10], input$selectAirline[11], input$selectAirline[12], input$selectAirline[13], input$selectAirline[14], input$selectAirline[15], input$selectAirline[16], input$selectAirline[17], input$selectAirline[18], input$selectAirline[19], input$selectAirline[20], input$selectAirline[21], input$selectAirline[22], input$selectAirline[23], input$selectAirline[24], input$selectAirline[25], input$selectAirline[26], input$selectAirline[27], input$selectAirline[28], input$selectAirline[29], input$selectAirline[30], input$selectAirline[31], input$selectAirline[32], input$selectAirline[33], input$selectAirline[34], input$selectAirline[35], input$selectAirline[36], input$selectAirline[37], input$selectAirline[38], input$selectAirline[39], input$selectAirline[40], input$selectAirline[41], input$selectAirline[42], input$selectAirline[43], input$selectAirline[44], input$selectAirline[45], input$selectAirline[46], input$selectAirline[47], input$selectAirline[48], input$selectAirline[49], input$selectAirline[50], input$selectAirline[51], input$selectAirline[52], input$selectAirline[53], input$selectAirline[54], input$selectAirline[55], input$selectAirline[56], input$selectAirline[57], input$selectAirline[58], input$selectAirline[59], input$selectAirline[60], input$selectAirline[61], input$selectAirline[62], input$selectAirline[63], input$selectAirline[64], input$selectAirline[65], input$selectAirline[66], input$selectAirline[67], input$selectAirline[68], input$selectAirline[69], input$selectAirline[70], input$selectAirline[71], input$selectAirline[72], input$selectAirline[73], input$selectAirline[74], input$selectAirline[75], input$selectAirline[76], input$selectAirline[77], input$selectAirline[78], input$selectAirline[79], input$selectAirline[80], input$selectAirline[81], input$selectAirline[82], input$selectAirline[83], input$selectAirline[84], input$selectAirline[85], input$selectAirline[86], input$selectAirline[87], input$selectAirline[88], input$selectAirline[89], input$selectAirline[90], input$selectAirline[91], input$selectAirline[92], input$selectAirline[93], input$selectAirline[94], input$selectAirline[95], input$selectAirline[96], input$selectAirline[97], input$selectAirline[98], input$selectAirline[99], input$selectAirline[100], input$selectAirline[101], input$selectAirline[102], input$selectAirline[103], input$selectAirline[104], input$selectAirline[105], input$selectAirline[106], input$selectAirline[107], input$selectAirline[108], input$selectAirline[109], input$selectAirline[110], input$selectAirline[111], input$selectAirline[112], input$selectAirline[113], input$selectAirline[114], input$selectAirline[115], input$selectAirline[116], input$selectAirline[117])
  data.world::query(paramQuery, dataset = project)
}) 
```




```{r}
airlines <- eventReactive(c(input$selectAirline), { 
 library('stringr')
  str_c(input$selectAirline, collapse=', ')
})
```

#NOTE: Canattaa had shorter code for this seciton on tophat...but aybe cuz that is now order ate is a thing

#you can loo up renderTable on the shiny cheat sheet
#then we pipe it with a function called dplyr but then we add another column
#called quarter with the code from "Daplr" to (order_date))



```{r}
 #Notice the need to use df1() below:
renderDataTable({
  
  DT::datatable(df(), rownames = FALSE, 
  extensions = list(Responsive = TRUE, FixedHeader = TRUE)
  )
})
```


#Render and Display the Categories Boxplot

Using [ggplotly](https://www.rdocumentation.org/packages/plotly/versions/4.7.1/topics/ggplotly)

```{r}
tabsetPanel( 
  tabPanel("Settings:"),# To create a tab panel - see https://shiny.rstudio.com/reference/shiny/latest/tabPanel.html
  tabPanel("Plot Size", 
    numericInput("plotWidth_1", "Plot Width:", 800),
    numericInput("plotHeight_1", "Plot Height:", 600)),
  tabPanel("Plot Title",
    textInput("title_1", "Title", "Region Sales"),
    numericInput("titleFont_1", "Title Font", 10)), 
  tabPanel("Plot Legend",
    numericInput("legendTitleSize_1", "Legend Title Size", 10),
    numericInput("legendItemSize_1", "Legend Item Size", 10),
    numericInput("legendKeySize_1", "Legend Key Size", 5)), 
  tabPanel("Axis Labels",
    textInput("xLabel_1", "x-Axis Label", "Category"),
    textInput("yLabel_1", "y-Axis Label", "Sales"),
    numericInput("textFont_1", "textFont:", 10)),
  tabPanel("Data Size", 
    numericInput("yDataMin_1", "yData Minimum (Required):", NA),
    numericInput("yDataMax_1", "yData Maximum (Required):", NA)))
```


```{r}
df1 <- eventReactive(c(input$selectAirline, input$yDataMin_1, input$yDataMax_1), { 
  if( ! is.na(input$yDataMin_1) & ! is.na(input$yDataMax_1)) {
    df() %>% dplyr::filter(between(closeAmount, input$yDataMin_1, input$yDataMax_1))
  }
  else {
    df()
  }
})
```





```{r}
# Boxplot - see http://ggplot2.tidyverse.org/reference/geom_boxplot.html
# Notice the need to use df(), and Regions() below:
renderPlotly({
  plot = df1() %>% ggplot() + 
    geom_boxplot(mapping = aes(x = airline_name, y=close_amount, colour = airline_name)) +
     
    theme(plot.title = element_text(size = input$titleFont_1, face = "bold")) + 
    theme( # Legend Attributes - see https://github.com/tidyverse/ggplot2/wiki/Legend-Attributes
      legend.title=element_text(size=input$legendTitleSize_1), 
      legend.text=element_text(size=input$legendItemSize_1),
      legend.key = element_rect(size = input$legendKeySize_1),
      legend.key.size = unit(input$legendKeySize_1, 'lines')) +
    theme(axis.text=element_text(size=input$textFont_1),
          axis.title=element_text(size=input$textFont_1, face="bold"),
          axis.text.x = element_text(angle = 90, hjust = 1))  +
    theme(plot.margin=unit(c(2,1,1,1),"cm")) +
    scale_y_continuous(labels = scales::comma) + # Disable scientific notation
    ggtitle(paste(airlines(), input$title_1)) +
    xlab(input$xLabel_1) + ylab(input$yLabel_1)
  ggplotly(plot, tooltip = c("closeAmount"), session="knitr", width = input$plotWidth_1, height = input$plotHeight_1)
})
```

```{r}
inputPanel( 
  textInput("dummy_2", "", "")
  )
```

```{r}
inputPanel( 
  textInput("dummy_2", "", "")
  )
```




   
#Render and Display the Quarters Boxplot

Using [ggplotly](https://www.rdocumentation.org/packages/plotly/versions/4.7.1/topics/ggplotly)

```{r}
tabsetPanel( 
  tabPanel("Settings:"),# To create a tab panel - see https://shiny.rstudio.com/reference/shiny/latest/tabPanel.html
  tabPanel("Plot Size", 
    numericInput("plotWidth_2", "Plot Width:", 800),
    numericInput("plotHeight_2", "Plot Height:", 600)),
  tabPanel("Plot Title",
    textInput("title_2", "Title", "Region Sales"),
    numericInput("titleFont_2", "Title Font", 10)), 
  tabPanel("Plot Legend",
    numericInput("legendTitleSize_2", "Legend Title Size", 10),
    numericInput("legendItemSize_2", "Legend Item Size", 10),
    numericInput("legendKeySize_2", "Legend Key Size", 5)), 
  tabPanel("Axis Labels",
    textInput("xLabel_2", "x-Axis Label", "Quarter"),
    textInput("yLabel_2", "y-Axis Label", "Sales"),
    numericInput("textFont_2", "textFont:", 10)),
  tabPanel("Data Size", 
    numericInput("yDataMin_2", "yData Minimum (Required):", NA),
    numericInput("yDataMax_2", "yData Maximum (Required):", NA)))
```

```{r}
df2 <- eventReactive(c(input$selectRegion_1, input$yDataMin_2, input$yDataMax_2), { 
  if( ! is.na(input$yDataMin_2) & ! is.na(input$yDataMax_2)) {
    df() %>% dplyr::filter(between(closeAmount, input$yDataMin_2, input$yDataMax_2))
  }
  else {
    df()
  }
})
```

```{r}
# Boxplot - see http://ggplot2.tidyverse.org/reference/geom_boxplot.html
# Notice the need to use df(), and Regions() below:
renderPlotly({
  plot = df2() %>% ggplot() + 
    geom_boxplot(mapping = aes(x = as.factor(paste(lubridate::year(incident_d),"_",lubridate::quarter(incident_d))), y=close_amount, colour = airline_name)) +
     
    theme(plot.title = element_text(size = input$titleFont_2, face = "bold")) + 
    theme( # Legend Attributes - see https://github.com/tidyverse/ggplot2/wiki/Legend-Attributes
      legend.title=element_text(size=input$legendTitleSize_2), 
      legend.text=element_text(size=input$legendItemSize_2),
      legend.key = element_rect(size = input$legendKeySize_2),
      legend.key.size = unit(input$legendKeySize_2, 'lines')) +
    theme(axis.text=element_text(size=input$textFont_2),
          axis.title=element_text(size=input$textFont_2, face="bold"),
          axis.text.x = element_text(angle = 90, hjust = 1))  +
    theme(plot.margin=unit(c(2,1,1,1),"cm")) +
    scale_y_continuous(labels = scales::comma) + # Disable scientific notation
    ggtitle(paste(airlines(), input$title_2)) +
    xlab(input$xLabel_2) + ylab(input$yLabel_2)
  ggplotly(plot, tooltip = c("sales"), session="knitr", width = input$plotWidth_2, height = input$plotHeight_2)
})
```

