---
title: "The Prices of AirBnB Units: An Interactive Document"
author: "Kyle DeQuesnay, Jeffrey Feng,Brandon Kerbow, Derek Orji"
resource_files:
- .Renviron
output:
  html_notebook:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
runtime: shiny
---

#Dataset Description - NEEDS UPDATING FOR PROJECT 4
This dataset was obtained online from the World Health Organization (WHO) and contains various health-related metrics for every country on the planet. Examples of such metrics include the average per capita (per person) income and average life expectancy. There are also fields for the region (e.g. Western Europe, Sub-Saharan Africa) and the system of government in place (e.g. Republic, Absolute Monarchy) for each country.

#Important Links - Github Link NEEDS UPDATING FOR PROJECT 4

[Data.world Project](https://data.world/brandon-kerbow/s18-edv-project-4)

Kyle's Insights: [1](https://data.world/brandon-kerbow/s18-edv-project-4/insights/c0365682-6ca9-424a-8617-8c80051940ac)
[2](https://data.world/brandon-kerbow/s18-edv-project-4/insights/883d3021-1691-4801-bc1c-064a8d5dac04)

Jeffrey's Insights:
[1](https://data.world/brandon-kerbow/s18-edv-project-4/insights/d4ee2f89-adf9-48f9-a394-96750c428b91)
[2](https://data.world/brandon-kerbow/s18-edv-project-4/insights/1778e3bd-a498-4d75-969b-39edbfae4419)

Brandon's Insights:
[1](https://data.world/brandon-kerbow/s18-edv-project-4/insights/be381f9b-b05f-4558-862b-7e0a38e19110)
[2](https://data.world/brandon-kerbow/s18-edv-project-4/insights/cd77eb59-889f-4b36-b0ec-12df8efb51eb)

Derek's Insights:
[1](https://data.world/brandon-kerbow/s18-edv-project-4/insights/8de30184-b578-4280-ac35-d850460c63aa)
[2](https://data.world/brandon-kerbow/s18-edv-project-4/insights/bf9ebbbd-f4ad-47a4-9cfd-adb4f171be7e)

[Github Repository](https://github.com/CannataUTDV/s18dvproject3-duquesnay-feng-orji-kerbow)

#Motivations and Expectations - NEEDS UPDATING FOR PROJECT 4
With healthcare being a hot topic in both business and everyday life, we wanted to explore some drivers for health on a global scale. Because one of the most common obstacles in improving global health is a lack of funds, we aimed to explore how countries - of different government types and in different geographic regions - can benefit from increasing the amount they spend on healthcare. We also recognize that in many countries, particularly 3rd world countries, it is common for women to give birth to a relatively high number of children. With this in mind, we explored what factors could affect the prevalence of contraception (in other words, the accessibility of birth control such as condoms or pills). We also wanted to explore the overall health of countries by analyzing demographics/age distributions and the potential relationships with factors such as income. As an interesting final point of interest, we wanted to see if there is a relationship between climate (approximated by average annual temperature) and average number of women per children. 

We expect to see that countries which spend more on healthcare have better health (measured by things such as life expectancy) for every region and system of government. We also expect to see that women in poorer nations give birth to more children and that countries with aging populating are not as healthy as their middle-aged country counterparts. Finally, we expect there to be little correlation between climate and the average number of children per woman. More specific expectations are in the sections for each dashboard further down in this interactive document. 

#Summary of Conclusions - NEEDS UPDATING FOR PROJECT 4
Through our analysis of the data and visuals in subsequent sections, we found that our expectations were not always correct. Although it is true that that countries which spend more on healthcare tend to have better health-related metrics, the relationship does not always hold for all metrics and systems and government. Additionally, what plays into the prevalence of contraceptive is more than just average income and aging populations are not necessarily unhealthier than their middle-aged country counterparts. Lastly, we did observe a pattern in climate vs average number of children per woman: as average temperature rose, so did the number of children. More specific conclusions for each dashboard can be found in each dashboards corresponding text. 

#Embedded Tableau Insight - NEEDS UPDATING FOR PROJECT 4

The conclusions drawn from this visualization are more easily seen in fullscreen mode.

By comparing review scores to true or false values on if properties have access to waterfronts or not, it can be seen through the use of boxplots that review scores tend to be higher when a property has access to waterfronts. Even those properties that have pool access, with some low outliers, have the majority of review scores greater than or equal to 70.

<iframe src="https://public.tableau.com/views/Proximitytowaterseffectonreviewscore/Dashboard1?:showVizHome=no"width="800" height="800"></iframe>


```{r setup, echo=FALSE, message=FALSE}
library(tidyverse)
library(shiny)
library(grid)
library(data.world)
library(DT)
library(shinydashboard)
library(plotly)
library(lubridate)
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
source("brandonDataA.R", local = TRUE)
source("brandonDataB.R", local = TRUE)

```
```{r}
source("JeffDataA.R", local = TRUE)
source("JeffDataB.R", local = TRUE)


```

```{r}
projectBrandon <- "https://data.world/brandon-kerbow/s18-edv-project-4" 
data.world::set_config(cfg_env("DW_API")) 
cities <- data.world::query(data.world::qry_sql(
 "   
	select distinct city
	from AirBnBClean
 "), 
dataset = projectBrandon)
```

```{r}
project <- "https://data.world/brandon-kerbow/s18-edv-project-4/" 
data.world::set_config(cfg_env("DW_API")) 
city <- data.world::query(data.world::qry_sql(
  "   
  select distinct airbnbclean.city from airbnbclean
  "), 
  dataset = project)
```

```{r}
project <- "https://data.world/brandon-kerbow/s18-edv-project-4/" 
data.world::set_config(cfg_env("DW_API")) 
price <- data.world::query(data.world::qry_sql(
  "   
  select distinct airbnbclean.nightly_price from airbnbclean
  "), 
  dataset = project)
```

```{r}
project <- "https://data.world/brandon-kerbow/s18-edv-project-4/" 
data.world::set_config(cfg_env("DW_API")) 
propType <- data.world::query(data.world::qry_sql(
  "   
  select distinct airbnbclean.property_type from airbnbclean
  "), 
  dataset = project)
```

```{r}
project <- "https://data.world/brandon-kerbow/s18-edv-project-4/" 
data.world::set_config(cfg_env("DW_API")) 
income <- data.world::query(data.world::qry_sql(
  "   
  select distinct IRSIncomeByZipCode.avg_total_income from IRSIncomeByZipCode
  "), 
  dataset = project)
```


#Brandons
#Exploring Loft Prices in LA - Bar Charts
This dashboard contains two tabs, both bar charts.  The dashboard - and the subsequent crosstab - explore the price differences of AirBnB postings by City and Property Type. We would expect that for cities which have higher prices, the higher price is equally represented across all property types. This was, however, found to not always be the case. We show that Los Angeles has disproportionally expensive loft units and explore why this may be so.

The dashboard's input panel allows the user to decide which cities(s) they would like to see present in the data. The slider for Average Price per Night filters which property types are shown for a given city based on whether or not that value falls within the bounds. Note that for these plots, and some others on this document, the text in the legend is quite small. This is to avoid having the legend overlay the plot.

##Tab 1 - Discovering the Abnormally Expensive LA Lofts
The first tab's bar chart shows the Average Price per Night (y-axis) for each City (x-axis) by property type (color). It is immediately clear that Washington D.C. and San Francisco have the most expensive rentals overall, but it is more interesting to compare the different property types across cities. Los Angeles, for example, has the second to shortest stack (i.e. the second cheapest overall rentals) but the second to highest average nightly price for lofts (shown in blue). This indicates that LA has disproportionally expensive lofts, but why is this the case? The visual in the second tab and the subsequent crosstab shed some light on this.

##Tab 2 - Charging Extra for Pets
The second tab's bar chart is filtered to only show lofts and - just like the first tab -  has Average Price per Night and City on the y and x axes, respectively. This plot, however, has the bars colored based on whether or not the loft allows pets. We see that LA, relative to the other cities, has lofts which charge disproportionately more for the luxury of allowing pets. Given that most of the lofts across all cities allow pets, this plays into LA having disproportionally expensive lofts. Though interesting, this is likely not one of the biggest drivers of LA's disproportionally expensive lots. To see a bigger reason for this observation, we observe the subsequent crosstab.






```{r}
inputPanel(
  selectInput("selectCity_1", label = "Select City",choices = cities, multiple=TRUE, selected=c
("NYC",
"LA",
"DC",
"SF",
"Chicago",
"Boston")),

  sliderInput("PriceFilter", label = "Average Price per Night:",
              min = 0, max = 400, value = c(0, 400), step = 20)
)
```


```{r}
dashboardPage(
  dashboardHeader(
  ),
  dashboardSidebar(
    sidebarMenu(
      menuItem("Price by Property Type", tabName = "barchartBrandon", icon = icon("dashboard")),
      menuItem("Price by Pet Policy", tabName = "barchart2Brandon", icon = icon("dashboard"))
    )
  ),
  dashboardBody(
    tabItems(
      # 1. "BarChart2"
      tabItem(tabName = "barchartBrandon",
        p("This is a barchart of City and Average Price per Night, by Property Type"),
        source("brandonbarChart1UI.R",local = TRUE)$value
      ),
       # 2. "BarChart1"
      tabItem(tabName = "barchart2Brandon",
        p("This is a barchart of City and Average Price per Night, by Pet Policy"),
        source("brandonbarChart2UI.R",local = TRUE)$value
      )
    )
  )
)
source("brandonbarChart1Server.R", local = TRUE)
source("brandonbarChart2Server.R", local = TRUE)

```

#Exploring Loft Prices in LA - Crosstab
This crosstab shows the Average Price Per Night for lofts by City and Type of Room. The x and y axes show the City and Type of Room, respectively. The data within the crosstab shows the Average Price per Night. The colors provide a conditional formatting to make it apparent where the small (blue), medium (green), and large (red) prices are. Cities can be filtered out with input box and the sliders control the thresholds for being classified as small, medium, and large. A value is considered large if it is greater than the "bottom high" value, small if it is smaller than the "top low" value, and medium otherwise (i.e. between these two values).

Similar to the bar charts, we would expect that cities which have more expensive loft prices have this higher price represented equally across all types of lofts. Instead however, we see that lofts which are private rooms are significantly more expensive in LA than any other city, contributing to LA's disproportionately expensive lofts which was observed in the previous dashboard's first tab.

```{r}
inputPanel(
  selectInput("selectCity_2", label = "Select City",
              choices = cities, multiple=TRUE, selected=c
              
  ("NYC","LA","DC","SF","Chicago","Boston")),
              
              
  sliderInput("bottomHigh", label = "Bottom High:",
              min = 200, max = 400, value = 200, step = 10),
  
  sliderInput("topLow", label = "Top Low:",
              min = 60, max = 150, value = 100, step = 5)
)
```


```{r}
dfBrandon <- eventReactive(c(input$selectCity_2, input$bottomHigh, input$topLow), { 
  project <- "https://data.world/brandon-kerbow/s18-edv-project-4" 
  data.world::set_config(cfg_env("DW_API")) 
  paramQuery <- data.world::qry_sql(
   "   
    select cast(avg(nightly_price) as int) as continuous_kpi, city, room_type,
    case 
    when avg(nightly_price) > ? then 'Large'
    when avg(nightly_price) < ? then 'Small'
    else 'Medium'
    end as discrete_kpi
    from AirBnBClean s
    where property_type = 'Loft'
    group by city, room_type
    
    --where city in (?, ?, ?, ?, ?, ?)
   ")
  # paramQuery$params <- c(input$bottomHigh, input$topLow, input$selectRegion)
  paramQuery$params <- c(input$bottomHigh, input$topLow)
  data.world::query(paramQuery, dataset = project)
}) 

# The following is needed because  what's in the SQL query above doesn't work if uncommented
df1BrandonCrosstab <- eventReactive(c(input$bottomHigh, input$topLow, input$selectCity_2), { 
  dfBrandon() %>% dplyr::filter(city %in% input$selectCity_2)
})

Cities <- eventReactive(c(input$selectCity_2), { 
  library('stringr')
  str_c(input$selectCity_2, collapse=', ')
})

# Notice the need to use df1() below:
renderDataTable({
  DT::datatable(df1BrandonCrosstab(), rownames = FALSE,
  extensions = list(Responsive = TRUE, FixedHeader = TRUE)
  )
})
```


```{r}
renderPlot({
  df1BrandonCrosstab() %>% ggplot() + geom_text(mapping = aes(x=city, y=room_type, label=continuous_kpi), size=20) +
  geom_tile(aes(x=city, y=room_type, fill=discrete_kpi), alpha=0.50) +
  theme(legend.text=element_text(size=45)) +
  theme(axis.text=element_text(size=45),
        axis.title=element_text(size=45, face="bold"))  + 
  theme(plot.title = element_text(size = 60, face = "bold")) + 
  ggtitle(paste("Average Price per Night, by City and Room Type")) +
  xlab("City") + ylab("Room Type")
}, height = 2000, width = 2000
)
```


#Kyles
```{r}

df1kyle <- eventReactive(c(input$selectPrice_1kyle, input$selectCity_1kyle), { 
  project <- "https://data.world/brandon-kerbow/s18-edv-project-4/" 
  data.world::set_config(cfg_env("DW_API")) 
  paramQuery <- data.world::qry_sql(
    "
    select city, nightly_price, property_type
    from airbnbclean h
    where nightly_price between ? and ? and city in (?,?,?,?,?,?) and property_type in ('Apartment','Bed_&_Breakfast', 'Boat', 'Boutique_hotel', 'Bungalow', 'Cabin', 'Camper/RV', 'Castle', 'Condominium', 'Dorm', 'Guest_suite', 'Guesthouse', 'Hostel', 'House', 'In-law', 'Loft', 'Other', 'Serviced_apartment', 'Timeshare', 'Tipi', 'Townhouse', 'Treehouse', 'Villa')
    
    order by city
    "
    )
  paramQuery$params <- c(input$selectPrice_1kyle[1], input$selectPrice_1kyle[2], input$selectCity_1kyle[1], input$selectCity_1kyle[2], input$selectCity_1kyle[3], input$selectCity_1kyle[4], input$selectCity_1kyle[5], input$selectCity_1kyle[6])
  data.world::query(paramQuery, dataset = project)
}) 

```


```{r}

df2kyle <- eventReactive(c(input$selectIncome_2kyle, input$selectCity_1kyle), { 
  project <- "https://data.world/brandon-kerbow/s18-edv-project-4/" 
  data.world::set_config(cfg_env("DW_API")) 
  paramQuery <- data.world::qry_sql(
    "   
        select * from(
    
    select city, property_type, cast(c.avg_total_income as int) as avg_total_income_for_zipcode
    from airbnbclean a
    LEFT JOIN 
    (SELECT replace(a.zipcode,',','') as zipcode, a.avg_total_income
    FROM irsincomebyzipcode a)c
    
    on a.zipcode = c.zipcode) d
    
   where avg_total_income_for_zipcode  between ? and ? and city in (?,?,?,?,?,?) and property_type in ('Apartment','Bed_&_Breakfast', 'Boat', 'Boutique_hotel', 'Bungalow', 'Cabin', 'Camper/RV', 'Castle', 'Condominium', 'Dorm', 'Guest_suite', 'Guesthouse', 'Hostel', 'House', 'In-law', 'Loft', 'Other', 'Serviced_apartment', 'Timeshare', 'Tipi', 'Townhouse', 'Treehouse', 'Villa')
    
    order by city
    
    

    
    
    ")
  paramQuery$params <- c(input$selectIncome_2kyle[1], input$selectIncome_2kyle[2], input$selectCity_1kyle[1], input$selectCity_1kyle[2], input$selectCity_1kyle[3], input$selectCity_1kyle[4], input$selectCity_1kyle[5], input$selectCity_1kyle[6])
  data.world::query(paramQuery, dataset = project)
}) 

```


```{r}
City <- eventReactive(c(input$selectCity_1kyle), { 
  library('stringr')
  str_c(input$selectCity_1kyle, collapse=', ')
})
```

```{r}
Price <- eventReactive(c(input$selectPrice_1kyle), { 
  library('stringr')
  str_c(input$selectPrice_1kyle, collapse=', ')
})
```

```{r}
City2 <- eventReactive(c(input$selectCity_2kyle), { 
  library('stringr')
  str_c(input$selectCity_1kyle, collapse=', ')
})
```

```{r}
Income <- eventReactive(c(input$selectIncome_2kyle), { 
  library('stringr')
  str_c(input$selectIncome_2kyle, collapse=', ')
})
```

Comparing income and nightly prices

In these boxplots, we list cities on the x axis and list our color index as property types. In one tab, we place nightly price for airbnb properties on the y axis, and in the other, we place average income per zipcode. 

In this way, we can compare prices in an area of the property to the incomes. 

The most interesting thing I discovered in this way was that the most expensive apartments were in New York City, and it so happened that the areas of some of these apartments also typically had the highest average incomes when compared to other cities.

One unexpected discovery was the presence of a castle in San Francisco for rent, with a fairly low nightly price and in an area with a fairly low average income.


```{r}
inputPanel(
  selectInput("selectCity_1kyle", label = "Select Cities",choices = city, multiple=TRUE, selected=c("Boston", "Chicago", "DC", "LA", "NYC", "SF")
    
  )
  
  ,sliderInput("selectPrice_1kyle", label = "Nightly Price", min = 0, max = 2000, value = c(0, 2000), step = 5),
  
  sliderInput("selectIncome_2kyle", label = "Average Income", min = 0, max = 1000, value = c(0, 1000), step = 5)
)
```

```{r}
dashboardPage(
  dashboardHeader(
  ),
  dashboardSidebar(
    sidebarMenu(
      menuItem("airbnbdata", tabName = "boxplot1", icon = icon("dashboard1")),
      menuItem("airbnbdata2", tabName = "boxplot2", icon = icon("dashboard1"))
    )
  ),
  dashboardBody(
    tabItems(
      # 1. "Nightly price" tab content
      tabItem(tabName = "boxplot1",
              source("kyleBoxPlot1UI.R",local = TRUE)$value
      ),
      # 2. "Average income per zipcode" tab content
      tabItem(tabName = "boxplot2",
              source("kyleBoxPlot2UI.R",local = TRUE)$value
              )
    )
  )
)

source("kyleBoxPlot1Server.R", local = TRUE)
source("kyleBoxPlot2Server.R", local = TRUE)

```



#Jeffs


Below are three plots. THe first of which is a histogram of nightly prices with the various colors depicting the different cities. By default, the six cities that are within the dataset are selected, but they can be selected using the input panel. It can be observed that obviously seen that New York and LA dominate the relatively lower price range. However, by using the zoom tool and closing in on the latter half of the plot, San Francisco seems to be another large player. 

This is supported by the next plot which is a boxplot of nightly prices by cities. San Francisco has a higher median for nightly prices while NYC and LA had larger maximums and outliers.

The next boxplot shows the average income of the zipcode containing the rental and the six cities. The plot shows only a couple outliers for San Francisco while NYC has not only more outliers but also larger variance. This reflects the trends found in previous plots. For New York, the wider span of income levels by zipcodes is a possible reason for the variability in nightly prices for rentals. This effect is also seen in San Francisco, where the generally more expensive zipcodes results in higher nightly prices.

```{r}
inputPanel(
  selectInput("selectCity_1", label = "Select City",choices = cities, multiple=TRUE, selected=c("DC","NYC","LA","SF","Chicago","Boston"))
)
```


```{r}
dashboardPage(
  dashboardHeader(
  ),
  dashboardSidebar(
    sidebarMenu(
      menuItem("Histogram", tabName = "histogram", icon = icon("dashboard")),
      menuItem("Boxplot", tabName = "boxplot", icon = icon("dashboard")),
      menuItem("Boxplot2", tabName = "jeffboxplot2", icon = icon("dashboard"))
      
    )
  ),
  dashboardBody(
    tabItems(
      # 1. "Histo
      tabItem(tabName = "histogram",
        p("This is a histogram of nightly prices"),
        source("Histogram2UI.R",local = TRUE)$value
      ),
      # 2. "Boxplot 1
      tabItem(tabName = "boxplot",
        p("This is a boxplot of nightly prices"),
        source("Boxplot1UI.R",local = TRUE)$value
      ),
      # 3. "Boxplot 2
      tabItem(tabName = "jeffboxplot2",
        p("This is a boxplot of Avg total income"),
        source("Boxplot2UI.R",local = TRUE)$value
      )
    )
  )
)
source("Histogram2Server.R", local = TRUE)
source("Boxplot1Server.R", local = TRUE)
source("Boxplot2Server.R", local = TRUE)


```




#Appendix - UPDATE DATA CLEANING FOR PROJECT 4

##Data Cleaning Code
(Click "code" to your right to see the code)
```{r, eval= FALSE}
library(tidyverse)
csvURL <- "https://query.data.world/s/8NFAXz99XN1E_ZYGRuRCCL7d751DpX"
df <- read_csv(csvURL, col_types = list(
  country = col_character(),
 
  adult_literacy_rate = col_number(), #changed to numbers
  gross_national_income_per_capita_ppp_international = col_number(), 
  population_in_thousands_total = col_number(), 
  population_median_age_years = col_number(),
  per_capita_total_expenditure_on_health_ppp_int = col_number(),
  per_capita_government_expenditure_on_health_ppp_int = col_number(),
  healthy_life_expectancy_hale_at_birth_years_both_sexes = col_number(),
  life_expectancy_at_birth_years_both_sexes =col_number(),
  population_with_sustainable_access_to_improved_sanitation_total = col_number(),
  aid_received_total = col_number(),
  income_per_person= col_number(),
  population_proportion_over_60= col_number(),
  population_proportion_under_15= col_number(),
  contraceptive_prevalence= col_number(),
  total_expenditure_on_health_as_percentage_of_gross_domestic_product= col_number(),
  children_per_woman= col_number(),
  infant_mortality_rate= col_number(),
  patents_granted= col_number()
  
))
  



# Remove non-printable characters from column names.
names(df) <- gsub("[^ -~]", "", names(df)) 
names(df) <- gsub(" ", "_", names(df)) 
#Get rid of null values
df[is.na(df)] <-0


# Remove non-printable characters from all column values.
df <- df %>% dplyr::mutate_all(funs(gsub(pattern="[^ -~]", replacement= "", .)))

# The following write_csv followed immediately by a read_csv, fixes the column types.
write_csv(df, "/Users/Jeffrey/Documents/school/Spring 2018/cs329/proj1/CS329DataViz/Project_3/WHO_clean.csv") 

df <- read_csv("/Users/Jeffrey/Documents/school/Spring 2018/cs329/proj1/CS329DataViz/Project_3/WHO_clean.csv", col_types = list(
  country = col_character(),
  
  adult_literacy_rate = col_number(), #changed to numbers
  gross_national_income_per_capita_ppp_international = col_number(), 
  population_in_thousands_total = col_number(), 
  population_median_age_years = col_number(),
  per_capita_total_expenditure_on_health_ppp_int = col_number(),
  per_capita_government_expenditure_on_health_ppp_int = col_number(),
  healthy_life_expectancy_hale_at_birth_years_both_sexes = col_number(),
  life_expectancy_at_birth_years_both_sexes =col_number(),
  population_with_sustainable_access_to_improved_sanitation_total = col_number(),
  aid_received_total = col_number(),
  income_per_person= col_number(),
  population_proportion_over_60= col_number(),
  population_proportion_under_15= col_number(),
  contraceptive_prevalence= col_number(),
  total_expenditure_on_health_as_percentage_of_gross_domestic_product= col_number(),
  children_per_woman= col_number(),
  infant_mortality_rate= col_number(),
  patents_granted= col_number()
))
# Now save the cleaned data to new.csv
write_csv(df, "/Users/Jeffrey/Documents/school/Spring 2018/cs329/proj1/CS329DataViz/Project_3/WHO_clean.csv")


# Now load /tmp/new.csv into a data.world Dataset.
```

##SessionInfo

```{r}
sessionInfo()
```

